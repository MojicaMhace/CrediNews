<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - CrediNews</title>
    <link rel="stylesheet" href="styles.css?v=layout-small-1">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="auth-body register-page">
    <div class="auth-container auth-split">
        <aside class="auth-hero has-image" style="background-image: url('images/credi_reg.png');">
        </aside>
        <div class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-shield-alt"></i>
                    <span>CrediNews</span>
                </div>
                <h2>Create Account</h2>
                <p>Join us to start analyzing news credibility</p>
            </div>

            
            <form class="auth-form" id="registerForm">
                <div class="form-group">
                    <label for="fullName">Full Name</label>
                    <input type="text" id="fullName" name="fullName" required pattern="^[A-Za-z][A-Za-z\s'-]*$" title="Use letters, spaces, apostrophes or hyphens; no numbers.">
                </div>

                <div class="form-group">
                    <label for="email">Email Address</label>
                    <input type="email" id="email" name="email" required>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required aria-describedby="passwordHelp">
                    <ul class="password-hints" id="passwordHelp">
                        <li id="req-length" class="invalid">• At least 8 characters</li>
                        <li id="req-upper" class="invalid">• Uppercase letter (A–Z)</li>
                        <li id="req-lower" class="invalid">• Lowercase letter (a–z)</li>
                        <li id="req-number" class="invalid">• Number (0–9)</li>
                        <li id="req-special" class="invalid">• Special character (!@#$…)</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required aria-describedby="confirmHint">
                    <div id="confirmHint" class="match-hint" style="display:none">• Passwords must match</div>
                </div>

                <div class="form-options">
                    <label class="checkbox-label">
                        <input type="checkbox" name="terms" required>
                        <span class="checkmark"></span>
                        <p>I agree to the <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a></p>
                    </label>
                </div>

                <button type="submit" class="auth-btn primary">
                    <i class="fas fa-user-plus"></i>
                    Create Account
                </button>

                <div class="divider">
                    <span>or</span>
                </div>

                <button type="button" class="auth-btn google" id="googleSignUp">
                    <i class="fab fa-google"></i>
                    Sign up with Google
                </button>
            </form>

            <div class="auth-footer">
                <p>Already have an account? <a href="login.html">Sign in</a></p>
            </div>
        </div>

        <div class="theme-toggle-auth">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>

    <!-- Firebase SDK v8 (more stable) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- EmailJS SDK -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    
    <script src="firebase-config.js"></script>
    <script src="emailjs-config.js"></script>
    <script src="auth.js"></script>

    <script>
    const auth = firebase.auth();

    // Disallow digits in Full Name as user types
    const fullNameInput = document.getElementById("fullName");
    if (fullNameInput) {
        fullNameInput.addEventListener("input", function() {
            this.value = this.value.replace(/[0-9]/g, "");
        });
    }

    function isValidFullName(name) {
        // Letters, spaces, apostrophes, and hyphens; must start with a letter
        return /^[A-Za-z][A-Za-z\s'-]*$/.test(name);
    }

    function isStrongPassword(pwd) {
        const rules = {
            length: (pwd || '').length >= 8,
            upper: /[A-Z]/.test(pwd || ''),
            lower: /[a-z]/.test(pwd || ''),
            number: /\d/.test(pwd || ''),
            special: /[!@#$%^&*()_+\-=[\]{};':"\\|,.<>\/?]/.test(pwd || '')
        };
        return Object.values(rules).every(Boolean);
    }

    function updatePasswordHints(pwd) {
        const states = {
            length: (pwd || '').length >= 8,
            upper: /[A-Z]/.test(pwd || ''),
            lower: /[a-z]/.test(pwd || ''),
            number: /\d/.test(pwd || ''),
            special: /[!@#$%^&*()_+\-=[\]{};':"\\|,.<>\/?]/.test(pwd || '')
        };
        const setState = (id, ok) => {
            const el = document.getElementById(id);
            if (!el) return;
            el.classList.toggle('valid', ok);
            el.classList.toggle('invalid', !ok);
        };
        setState('req-length', states.length);
        setState('req-upper', states.upper);
        setState('req-lower', states.lower);
        setState('req-number', states.number);
        setState('req-special', states.special);

        const pwdInput = document.getElementById('password');
        if (pwdInput) {
            const allOk = Object.values(states).every(Boolean);
            pwdInput.setCustomValidity(allOk ? '' : 'Password must be at least 8 characters and include uppercase, lowercase, number, and special character.');
        }
    }

    function updateConfirmHint(pwd, confirm) {
        const hint = document.getElementById('confirmHint');
        if (!hint) return;
        const confirmInput = document.getElementById('confirmPassword');
        const hasContent = (confirm || '').length > 0; // only show when typing

        if (!hasContent) {
            hint.style.display = 'none';
            if (confirmInput) confirmInput.setCustomValidity('');
            return;
        }

        hint.style.display = 'block';
        const match = (pwd || '') === (confirm || '');
        hint.classList.toggle('valid', match);
        hint.classList.toggle('invalid', !match);
        hint.textContent = match ? '✔ Passwords match' : '• Passwords must match';
        if (confirmInput) confirmInput.setCustomValidity(match ? '' : 'Passwords do not match.');
    }

    const pwdInput = document.getElementById('password');
    const confirmInput = document.getElementById('confirmPassword');
    if (pwdInput) {
        pwdInput.addEventListener('input', () => {
            updatePasswordHints(pwdInput.value);
            if (confirmInput) updateConfirmHint(pwdInput.value, confirmInput.value);
        });
        // Initialize hints on load
        updatePasswordHints(pwdInput.value);
    }
    if (confirmInput) {
        confirmInput.addEventListener('input', () => updateConfirmHint(pwdInput.value, confirmInput.value));
    }

    document.getElementById("registerForm").addEventListener("submit", function (e) {
        e.preventDefault();

        const fullName = document.getElementById("fullName").value.trim();
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;
        const confirmPassword = document.getElementById("confirmPassword").value;

        if (!isValidFullName(fullName)) {
            alert("⚠️ Please enter a valid full name using letters only (spaces, hyphens, apostrophes allowed).");
            return;
        }

        if (!isStrongPassword(password)) {
            alert("⚠️ Password must be at least 8 characters and include uppercase, lowercase, a number, and a special character.");
            return;
        }

        if (password !== confirmPassword) {
            alert("⚠️ Passwords do not match!");
            return;
        }

        auth.createUserWithEmailAndPassword(email, password)
            .then((userCredential) => {
                const user = userCredential.user;

                // ✅ Update display name first
                return user.updateProfile({
                        displayName: fullName
                    }).then(() => {
                        // ✅ Send email with redirect link (handle in app)
                        // Build a safe origin and retry without settings if invalid-continue-uri occurs
                        const safeOrigin = (window.location.origin && window.location.origin.startsWith('http'))
                          ? window.location.origin
                          : `${window.location.protocol}//${window.location.host}`;
                        const actionCodeSettings = {
                            url: `${safeOrigin}/login.html`,
                            handleCodeInApp: true
                        };
                        console.log('📧 Sending verification with continue URL:', actionCodeSettings.url);
                        return user.sendEmailVerification(actionCodeSettings)
                          .catch((err) => {
                            console.warn('⚠️ sendEmailVerification failed with actionCodeSettings, retrying without settings:', err && err.message);
                            return user.sendEmailVerification();
                          });

                    });
            })
            .then(() => {
                alert("✅ Account created successfully! A verification email was sent to " + email + ". Please verify your email before logging in.");
                // Optional: Keep them on register page until verification
            })
            .catch((error) => {
                alert("❌ " + error.message);
            });
    });
</script>
</body>
</html>